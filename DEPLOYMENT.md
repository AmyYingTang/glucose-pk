# è¡€ç³– PK åº”ç”¨ - éƒ¨ç½²ä¸ä½¿ç”¨æŒ‡å—

## ğŸ“ é¡¹ç›®ç»“æ„

```
glucose-pk/
â”œâ”€â”€ app.py                 # Flask ä¸»åº”ç”¨
â”œâ”€â”€ config.py              # é…ç½®åŠ è½½ï¼ˆä» .env è¯»å–ï¼‰
â”œâ”€â”€ data_fetcher.py        # Dexcom API æ•°æ®è·å–
â”œâ”€â”€ passkey_auth.py        # Passkey è®¤è¯æ¨¡å—
â”œâ”€â”€ password_manager.py    # å¯†ç ç®¡ç†å·¥å…·ï¼ˆç»Ÿä¸€æ¥å£ï¼‰
â”œâ”€â”€ requirements.txt       # Python ä¾èµ–
â”œâ”€â”€ .env.example           # é…ç½®æ¨¡æ¿
â”œâ”€â”€ .gitignore             # Git å¿½ç•¥æ–‡ä»¶
â””â”€â”€ static/                # å‰ç«¯æ–‡ä»¶
    â”œâ”€â”€ login.html         # ç™»å½•é¡µ
    â”œâ”€â”€ pk.html            # èµ›è·‘æ¸¸æˆ
    â”œâ”€â”€ castle.html        # åŸå ¡æ¸¸æˆ
    â”œâ”€â”€ river.html         # æ¼‚æµæ¸¸æˆ
    â””â”€â”€ js/                # JavaScript æ–‡ä»¶
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤ï¼ˆç®¡ç†å‘˜ï¼‰

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æœåŠ¡å™¨

```bash
# 1. å…‹éš†ä»£ç 
git clone <your-repo-url> glucose-pk
cd glucose-pk

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 3. å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### ç¬¬äºŒæ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶é…ç½®æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘é…ç½®ï¼ˆå¡«å†™ç”¨æˆ·ä¿¡æ¯ï¼Œå¯†ç ç¨åè®¾ç½®ï¼‰
nano .env
```

### ç¬¬ä¸‰æ­¥ï¼šå­˜å‚¨ Dexcom å¯†ç 

å·¥å…·ä¼š**è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ**ï¼Œé€‰æ‹©æœ€ä½³å­˜å‚¨æ–¹å¼ï¼š
- **Mac/Windows/Linuxæ¡Œé¢** â†’ Keyringï¼ˆç³»ç»Ÿé’¥åŒ™ä¸²ï¼‰
- **Linux æœåŠ¡å™¨ï¼ˆæ—  GUIï¼‰** â†’ åŠ å¯†æ–‡ä»¶

```bash
# æŸ¥çœ‹å½“å‰ç¯å¢ƒ
python password_manager.py status

# å­˜å‚¨å¯†ç ï¼ˆè‡ªåŠ¨é€‰æ‹©åç«¯ï¼‰
python password_manager.py set user1
# è¾“å…¥å¯†ç ...
# âœ… å¯†ç å·²ä¿å­˜ [keyring]: user1   â† Mac ä¸Š
# âœ… å¯†ç å·²ä¿å­˜ [encrypted]: user1 â† Linux æœåŠ¡å™¨ä¸Š

# å­˜å‚¨ç¬¬äºŒä¸ªç”¨æˆ·
python password_manager.py set user2
```

**å¼ºåˆ¶æŒ‡å®šåç«¯**ï¼ˆå¯é€‰ï¼‰ï¼š
```bash
# å¼ºåˆ¶ä½¿ç”¨ Keyring
python password_manager.py set user1 --backend=keyring

# å¼ºåˆ¶ä½¿ç”¨åŠ å¯†æ–‡ä»¶
python password_manager.py set user1 --backend=encrypted
```

**.env æ–‡ä»¶é…ç½®**ï¼š

```env
# ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸¤ç§åç«¯éƒ½éœ€è¦ï¼‰
USER_1_NAME=å››é¦™æ²¹é¥¼
USER_1_USERNAME=your_dexcom_username
USER_1_REGION=ous
USER_1_AVATAR=images/coffee.png
USER_1_COLOR=#0077BB

# å¦‚æœä½¿ç”¨ Keyringï¼šä¸éœ€è¦å¯†ç å­—æ®µ
# å¦‚æœä½¿ç”¨ encryptedï¼šå·¥å…·ä¼šè‡ªåŠ¨æ·»åŠ  USER_1_PASSWORD_ENCRYPTED=...
```

### ç¬¬å››æ­¥ï¼šé…ç½® HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰

Passkey è¦æ±‚ HTTPSï¼ˆlocalhost é™¤å¤–ï¼‰ã€‚æ¨èä½¿ç”¨ Nginx + Let's Encryptï¼š

```nginx
# /etc/nginx/sites-available/glucose-pk
server {
    listen 443 ssl;
    server_name your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:5010;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

```bash
# è·å– SSL è¯ä¹¦
sudo certbot --nginx -d your-domain.com
```

### ç¬¬äº”æ­¥ï¼šå¯åŠ¨åº”ç”¨

**å¼€å‘æ¨¡å¼ï¼š**
```bash
python app.py
```

**ç”Ÿäº§æ¨¡å¼ï¼ˆä½¿ç”¨ gunicornï¼‰ï¼š**
```bash
pip install gunicorn
gunicorn -w 4 -b 127.0.0.1:5010 app:app
```

**ä½¿ç”¨ systemd è‡ªåŠ¨å¯åŠ¨ï¼š**

```ini
# /etc/systemd/system/glucose-pk.service
[Unit]
Description=Glucose PK App
After=network.target

[Service]
User=www-data
WorkingDirectory=/path/to/glucose-pk
Environment="PATH=/path/to/glucose-pk/venv/bin"
ExecStart=/path/to/glucose-pk/venv/bin/gunicorn -w 4 -b 127.0.0.1:5010 app:app
Restart=always

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl enable glucose-pk
sudo systemctl start glucose-pk
```

---

## ğŸ‘¤ ç”¨æˆ·æ“ä½œæ­¥éª¤

### é¦–æ¬¡ä½¿ç”¨ï¼ˆåˆ›å»ºè´¦æˆ·ï¼‰

1. **è®¿é—®ç½‘ç«™**
   - æ‰“å¼€ `https://your-domain.com`
   - è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ

2. **åˆ›å»º Passkey**
   - çœ‹åˆ°"æ¬¢è¿ï¼é¦–æ¬¡è®¾ç½®"ç•Œé¢
   - è¾“å…¥ç”¨æˆ·åï¼ˆå¦‚ `admin`ï¼‰
   - ç‚¹å‡»ã€Œåˆ›å»º Passkeyã€
   - æµè§ˆå™¨å¼¹å‡ºè®¤è¯æç¤º â†’ ä½¿ç”¨æŒ‡çº¹/Face ID/PIN

3. **å®Œæˆ**
   - è‡ªåŠ¨ç™»å½•å¹¶è·³è½¬åˆ°ä¸»é¡µ
   - Passkey å·²ä¿å­˜åˆ°ä½ çš„è®¾å¤‡

### æ—¥å¸¸ç™»å½•

1. è®¿é—®ç½‘ç«™ â†’ è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ
2. ç‚¹å‡»ã€Œä½¿ç”¨ Passkey ç™»å½•ã€
3. æŒ‡çº¹/Face ID è®¤è¯
4. è¿›å…¥åº”ç”¨

### åœ¨æ–°è®¾å¤‡ä¸Šç™»å½•

**æ–¹å¼ Aï¼šä½¿ç”¨å·²æœ‰è®¾å¤‡æ‰«ç **
1. åœ¨æ–°è®¾å¤‡ä¸Šç‚¹å‡»ã€Œä½¿ç”¨ Passkey ç™»å½•ã€
2. é€‰æ‹©ã€Œä½¿ç”¨å…¶ä»–è®¾å¤‡ã€
3. ç”¨å·²ç™»å½•çš„æ‰‹æœºæ‰«æäºŒç»´ç 
4. åœ¨æ‰‹æœºä¸Šç¡®è®¤

**æ–¹å¼ Bï¼šæ·»åŠ æ–°è®¾å¤‡çš„ Passkey**
1. å…ˆç”¨æ–¹å¼ A ç™»å½•
2. è¿›å…¥åº”ç”¨åï¼Œè®¿é—® `/login.html`
3. åˆ‡æ¢åˆ°ã€Œæ·»åŠ è®¾å¤‡ã€æ ‡ç­¾
4. è¾“å…¥ç”¨æˆ·åï¼Œåˆ›å»ºæ–° Passkey
5. ä»¥åæ­¤è®¾å¤‡å¯ç›´æ¥ç™»å½•

### ç™»å‡º

```
è®¿é—® /api/auth/logoutï¼ˆPOST è¯·æ±‚ï¼‰
æˆ–æ¸…é™¤æµè§ˆå™¨ Cookie
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q: æœ¬åœ°å¼€å‘æ—¶ä¸æƒ³æ¯æ¬¡ç™»å½•ï¼Ÿ

åœ¨ `.env` ä¸­è®¾ç½®ï¼š
```env
AUTH_REQUIRED=false
```

### Q: å¿˜è®°äº† Passkey / è®¾å¤‡ä¸¢å¤±ï¼Ÿ

ç®¡ç†å‘˜éœ€è¦æ‰‹åŠ¨åˆ é™¤ç”¨æˆ·æ•°æ®ï¼š
```bash
# æŸ¥çœ‹ç”¨æˆ·
cat .passkey_users.json

# åˆ é™¤ç‰¹å®šç”¨æˆ·ï¼ˆPythonï¼‰
python -c "
import json
with open('.passkey_users.json', 'r+') as f:
    users = json.load(f)
    del users['ç”¨æˆ·å']
    f.seek(0)
    f.truncate()
    json.dump(users, f, indent=2)
"
```

### Q: è¿ç§»åˆ°æ–°æœåŠ¡å™¨ï¼Ÿ

**å¦‚æœä½¿ç”¨ Keyringï¼š**
```bash
# Keyring å¯†ç ä¸èƒ½è¿ç§»ï¼Œéœ€è¦åœ¨æ–°æœåŠ¡å™¨é‡æ–°è®¾ç½®
python password_manager.py
# é€‰æ‹© 1ï¼Œé‡æ–°è¾“å…¥æ¯ä¸ªç”¨æˆ·çš„ Dexcom å¯†ç 
```

**å¦‚æœä½¿ç”¨åŠ å¯†æ–‡ä»¶ï¼š**
```bash
# å¤åˆ¶è¿™äº›æ–‡ä»¶åˆ°æ–°æœåŠ¡å™¨
scp .env .secret_key .passkey_users.json user@new-server:/path/to/app/
```

éœ€è¦è¿ç§»çš„æ–‡ä»¶æ¸…å•ï¼š
| æ–‡ä»¶ | Keyring æ–¹æ¡ˆ | åŠ å¯†æ–‡ä»¶æ–¹æ¡ˆ |
|------|-------------|-------------|
| `.env` | âœ… éœ€è¦ | âœ… éœ€è¦ |
| `.secret_key` | âŒ ä¸éœ€è¦ | âœ… éœ€è¦ |
| `.passkey_users.json` | âœ… éœ€è¦ | âœ… éœ€è¦ |
| Dexcom å¯†ç  | ğŸ”„ é‡æ–°è®¾ç½® | å·²åœ¨ .env ä¸­ |

### Q: Passkey æç¤º"åŸŸåä¸åŒ¹é…"ï¼Ÿ

ç¡®ä¿ `.env` ä¸­çš„é…ç½®æ­£ç¡®ï¼š
```env
PASSKEY_RP_ID=your-domain.com          # ä¸å« https://
PASSKEY_ORIGIN=https://your-domain.com  # å« https://
```

RP_ID å¿…é¡»æ˜¯ ORIGIN çš„åŸŸåéƒ¨åˆ†æˆ–å…¶çˆ¶åŸŸåã€‚

### Q: å¦‚ä½•æ·»åŠ æ›´å¤š Dexcom ç”¨æˆ·ï¼Ÿ

åœ¨ `.env` ä¸­æ·»åŠ ï¼š
```env
USER_3_NAME=å°åˆš
USER_3_USERNAME=dexcom_username_3
USER_3_PASSWORD_ENCRYPTED=<åŠ å¯†å¯†ç >
USER_3_REGION=ous
USER_3_AVATAR=images/avatar3.png
USER_3_COLOR=#009988
```

ç„¶åé‡å¯åº”ç”¨ã€‚

---

## ğŸ“Š æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·æµè§ˆå™¨                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ç™»å½•é¡µ   â”‚  â”‚ èµ›è·‘æ¸¸æˆ â”‚  â”‚ åŸå ¡æ¸¸æˆ â”‚  â”‚ æ¼‚æµæ¸¸æˆ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Nginx (HTTPS)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Flask App                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Passkey è®¤è¯  â”‚  â”‚   API è·¯ç”±   â”‚  â”‚  é™æ€æ–‡ä»¶    â”‚  â”‚
â”‚  â”‚ (WebAuthn)   â”‚  â”‚ (è¡€ç³–æ•°æ®)   â”‚  â”‚  (HTML/JS)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Dexcom API                            â”‚
â”‚              (è·å–å®æ—¶è¡€ç³–æ•°æ®)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ å®‰å…¨æ¸…å•

- [x] Dexcom å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆFernet æˆ– Keyringï¼‰
- [x] Passkey æ— å¯†ç ç™»å½•
- [x] HTTPS åŠ å¯†ä¼ è¾“
- [x] Session Cookie åŠ å¯†
- [x] æ•æ„Ÿæ–‡ä»¶å·²åŠ å…¥ .gitignore
- [ ] å®šæœŸå¤‡ä»½ `.passkey_users.json`
- [ ] è®¾ç½®é˜²ç«å¢™åªå¼€æ”¾ 80/443 ç«¯å£
